<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>App Energ√≠as Alternativas - Calculadora Integral</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- html2pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
    :root{
        --bg:#e6f7ff;
        --card:#ffffff;
        --primary:#007bff;
        --success:#28a745;
        --muted:#444;
    }
    [data-theme="dark"]{
        --bg:#0f1724;
        --card:#1a2537;
        --primary:#3b82f6;
        --success:#16a34a;
        --muted:#ddd;
    }

    *{box-sizing:border-box;}
    body{
        margin:0;
        font-family: Arial, Helvetica, sans-serif;
        background:var(--bg);
        color:var(--muted);
        padding:20px;
        display:flex;
        justify-content:center;
    }

    .app{
        width:100%;
        max-width:1100px;
        background:var(--card);
        border-radius:12px;
        padding:20px;
        box-shadow:0 8px 25px rgba(0,0,0,0.15);
    }

    header{
        display:flex;
        justify-content:space-between;
        align-items:center;
        flex-wrap:wrap;
    }

    button{
        cursor:pointer;
    }

    .btn{
        padding:10px 14px;
        border:0;
        border-radius:8px;
        font-weight:bold;
        color:#fff;
    }
    .primary{background:var(--primary);}
    .success{background:var(--success);}
    .dark-grey{background:#666;}

    select, input{
        width:100%;
        padding:8px;
        border-radius:6px;
        border:1px solid #ccc;
        background:transparent;
        color:var(--muted);
    }

    .panel{
        padding:14px;
        border-radius:10px;
        background:rgba(255,255,255,0.05);
        margin-bottom:14px;
        border:1px solid rgba(0,0,0,0.05);
    }

    .apartado-item{
        display:flex;
        gap:10px;
        background:rgba(255,255,255,0.1);
        padding:10px;
        border-radius:8px;
        margin-bottom:10px;
    }
    .apartado-item button{
        background:#dc3545;
        border:0;
        padding:8px;
        border-radius:6px;
        color:#fff;
    }

    .resultado-total{
        padding:12px;
        border-radius:8px;
        background:rgba(0,128,0,0.08);
        margin-top:12px;
        border:1px solid rgba(0,128,0,0.2);
    }

    canvas{
        background:transparent;
        border-radius:8px;
    }
</style>
</head>

<body>
<div class="app" id="app" data-theme="light">

<header>
    <h1>üåû Calculadora Integral de Energ√≠a</h1>

    <div style="display:flex;gap:10px;align-items:center">
        <label>Modo oscuro</label>
        <input id="toggleTheme" type="checkbox">
        <button id="exportarPDF" class="btn primary">üìÑ PDF</button>
    </div>
</header>

<hr />

<!-- Selecci√≥n provincia/empresa -->
<div class="panel">
    <h3>1) Datos de ubicaci√≥n</h3>

    <div style="display:flex;gap:10px;flex-wrap:wrap">
        <div style="flex:1;min-width:160px">
            <label>Provincia</label>
            <select id="provinciaSelect"></select>
        </div>
        <div style="flex:1;min-width:160px">
            <label>Regi√≥n / Ciudad</label>
            <select id="regionSelect"></select>
        </div>
        <div style="flex:1;min-width:160px">
            <label>Empresa el√©ctrica</label>
            <select id="empresaSelect"></select>
        </div>
        <div style="flex:1;min-width:120px">
            <label>Segmento</label>
            <select id="segmentoSelect">
                <option value="N1">N1</option>
                <option value="N2">N2</option>
                <option value="N3">N3</option>
            </select>
        </div>
    </div>

    <div style="display:flex;gap:10px;margin-top:12px">
        <div style="flex:1">
            <label>Horas solares (editable)</label>
            <input type="number" id="horasSolaresInput" step="0.1">
        </div>
        <div style="flex:1">
            <label>Tarifa $/kWh (editable)</label>
            <input type="number" id="tarifaInput" step="0.1">
        </div>
    </div>
</div>

<!-- Aparatos -->
<div class="panel">
    <h3>2) Electrodom√©sticos</h3>
    <button id="agregar-aparato" class="btn success">‚ûï Agregar aparato</button>

    <div id="lista-aparatos" style="margin-top:12px"></div>

    <button id="calcular-total" class="btn primary" style="margin-top:10px">Calcular consumo</button>

    <div class="resultado-total" id="resultadoWrap">
        <h3>Resultados</h3>
        <p id="consumoResumen">0 kWh/d√≠a</p>
        <p id="costoResumen">$0/mes</p>
    </div>
</div>

<!-- Sugerencias -->
<div class="panel">
    <h3>3) Sugerencias y ranking</h3>
    <ul id="listaSugerencias"></ul>

    <h4>Ranking (kWh/d√≠a)</h4>
    <ol id="rankingAparatos"></ol>
</div>

<!-- Dim Solar -->
<div class="panel">
    <h3>4) Dimensionamiento Solar</h3>
    <p id="dimensionSolar">‚Äî</p>

    <label>Porcentaje de backup (%)</label>
    <input id="backup" type="number" min="0" max="100" value="20">
</div>

<!-- Gr√°fico -->
<div class="panel">
    <h3>5) Gr√°fico de consumo</h3>
    <canvas id="graficoConsumo"></canvas>
</div>

<div class="panel">
    <button id="compartirWhatsApp" class="btn success">üì≤ Compartir por WhatsApp</button>
</div>

</div>

<script>
/* ================================================
   BASE DE DATOS (editable a futuro)
================================================ */

const DB = {
    "Buenos Aires": {
        regiones: {
            "AMBA Norte": { horas: 4.2, empresas: ["EDENOR","EDESUR"] },
            "AMBA Sur":   { horas: 4.0, empresas: ["EDESUR","EDENOR"] },
            "Bah√≠a Blanca": { horas: 4.8, empresas: ["EDEA"] }
        }
    },
    "C√≥rdoba": {
        regiones: {
            "Capital": { horas: 5.0, empresas: ["EPEC"] },
            "Carlos Paz": { horas: 5.1, empresas: ["EPEC"] }
        }
    },
    "Mendoza": {
        regiones: {
            "Mendoza Capital": { horas: 5.6, empresas: ["EMESA"] }
        }
    }
};

const tarifas = {
    "EDENOR": {N1:160, N2:120, N3:80},
    "EDESUR": {N1:165, N2:125, N3:85},
    "EDEA": {N1:150, N2:110, N3:70},
    "EPEC": {N1:158, N2:118, N3:70},
    "EMESA": {N1:152, N2:112, N3:72},
};

/* ================================================
   SELECTORES
================================================ */

const provinciaSelect = document.getElementById("provinciaSelect");
const regionSelect = document.getElementById("regionSelect");
const empresaSelect = document.getElementById("empresaSelect");
const segmentoSelect = document.getElementById("segmentoSelect");

const horasSolaresInput = document.getElementById("horasSolaresInput");
const tarifaInput = document.getElementById("tarifaInput");

/* Poblar provincias */
Object.keys(DB).forEach(p=>{
    const opt=document.createElement("option");
    opt.value=p; opt.textContent=p;
    provinciaSelect.appendChild(opt);
});

function cargarRegiones(){
    regionSelect.innerHTML="";
    const prov=provinciaSelect.value;
    Object.keys(DB[prov].regiones).forEach(r=>{
        const opt=document.createElement("option");
        opt.value=r; opt.textContent=r;
        regionSelect.appendChild(opt);
    });
}
cargarRegiones();

function cargarEmpresas(){
    empresaSelect.innerHTML="";
    const prov=provinciaSelect.value;
    const reg=regionSelect.value;
    DB[prov].regiones[reg].empresas.forEach(e=>{
        const opt=document.createElement("option");
        opt.value=e; opt.textContent=e;
        empresaSelect.appendChild(opt);
    });
}
cargarEmpresas();

/* Actualizar datos autom√°ticos */
function actualizarDatos(){
    const prov=provinciaSelect.value;
    const reg=regionSelect.value;
    const emp=empresaSelect.value;
    const seg=segmentoSelect.value;

    horasSolaresInput.value = DB[prov].regiones[reg].horas;
    tarifaInput.value = tarifas[emp][seg];
}

provinciaSelect.onchange = ()=>{cargarRegiones(); cargarEmpresas(); actualizarDatos();}
regionSelect.onchange = ()=>{cargarEmpresas(); actualizarDatos();}
empresaSelect.onchange = actualizarDatos;
segmentoSelect.onchange = actualizarDatos;

actualizarDatos();

/* ================================================
   APARATOS
================================================ */

function crearAparato(nombre="",potencia="",horas=""){
    const div=document.createElement("div");
    div.className="apartado-item";

    div.innerHTML=`
        <input type="text" class="nombre" placeholder="Aparato" value="${nombre}">
        <input type="number" class="potencia" placeholder="W" value="${potencia}">
        <input type="number" class="horas" placeholder="Horas/d√≠a" step="0.1" min="0" max="24" value="${horas}">
        <button class="del">üóëÔ∏è</button>
    `;

    div.querySelector(".del").onclick = ()=>{
        div.remove();
        calcular();
    };

    document.getElementById("lista-aparatos").appendChild(div);
}

document.getElementById("agregar-aparato").onclick = ()=> crearAparato();

/* Iniciales */
crearAparato("Heladera",150,24);
crearAparato("Televisor",120,5);
crearAparato("Foco LED (x4)",40,6);

/* ================================================
   C√ÅLCULOS
================================================ */

let chart=null;

function calcular(){
    const items=document.querySelectorAll(".apartado-item");
    let totalDia=0;
    let detalle=[];

    items.forEach(i=>{
        const n=i.querySelector(".nombre").value;
        const w=parseFloat(i.querySelector(".potencia").value)||0;
        const h=parseFloat(i.querySelector(".horas").value)||0;
        if(w>0){
            const k=(w*h)/1000;
            totalDia+=k;
            detalle.push({nombre:n,kwh:k});
        }
    });

    const mensual=totalDia*30;
    const anual=totalDia*365;
    const tarifa=parseFloat(tarifaInput.value)||0;
    const costoMes=mensual*tarifa;

    document.getElementById("consumoResumen").textContent=
        `${totalDia.toFixed(3)} kWh/d√≠a ‚Ä¢ ${mensual.toFixed(1)} kWh/mes ‚Ä¢ ${anual.toFixed(1)} kWh/a√±o`;

    document.getElementById("costoResumen").textContent=
        `$${Math.round(costoMes)} / mes`;

    // Ranking
    detalle.sort((a,b)=>b.kwh-a.kwh);
    const ranking=document.getElementById("rankingAparatos");
    ranking.innerHTML="";
    detalle.forEach(d=>{
        ranking.innerHTML+=`<li>${d.nombre}: ${d.kwh.toFixed(3)} kWh/d√≠a</li>`;
    });

    // Sugerencias
    const sug=document.getElementById("listaSugerencias");
    sug.innerHTML="";
    if(totalDia>8) sug.innerHTML+="<li>Reducir el uso del aire acondicionado.</li>";
    if(totalDia>5) sug.innerHTML+="<li>Migrar toda la iluminaci√≥n a LED.</li>";
    if(totalDia>3) sug.innerHTML+="<li>Revisar eficiencia de la heladera.</li>";
    if(totalDia<3) sug.innerHTML+="<li>Tu hogar es eficiente.</li>";

    if(detalle.length>0 && detalle[0].kwh/totalDia>0.4){
        sug.innerHTML+=`<li>${detalle[0].nombre} consume m√°s del 40% del total.</li>`;
    }

    // Gr√°fico
    generarGrafico(detalle);

    // Solar
    dimensionarSolar(totalDia);
}

document.getElementById("calcular-total").onclick = calcular;

/* ================================================
   Gr√°fico
================================================ */

function generarGrafico(lista){
    const ctx=document.getElementById("graficoConsumo");

    if(chart) chart.destroy();

    chart=new Chart(ctx,{
        type:"bar",
        data:{
            labels:lista.map(x=>x.nombre),
            datasets:[{
                label:"kWh por d√≠a",
                data:lista.map(x=>x.kwh),
                backgroundColor:"rgba(0,123,255,0.5)"
            }]
        }
    });
}

/* ================================================
   Solar
================================================ */

function dimensionarSolar(kwh){
    const h=parseFloat(horasSolaresInput.value)||4.5;
    const potencia=(kwh/h)*1.3;
    const paneles=Math.ceil(potencia/0.45);
    const backup=parseFloat(document.getElementById("backup").value)||0;
    const baterias=(kwh*(backup/100)).toFixed(2);

    document.getElementById("dimensionSolar").innerHTML=
        `Requiere: <b>${potencia.toFixed(2)} kW</b> (${paneles} paneles).<br>
        Bater√≠a sugerida: ${baterias} kWh.`;
}

/* ================================================
   WhatsApp
================================================ */

document.getElementById("compartirWhatsApp").onclick=()=>{
    const c=document.getElementById("consumoResumen").textContent;
    const url="https://api.whatsapp.com/send?text="+encodeURIComponent("Mi consumo energ√©tico: "+c);
    window.open(url,"_blank");
};

/* ================================================
   PDF
================================================ */

document.getElementById("exportarPDF").onclick = ()=>{
    html2pdf().from(document.querySelector(".app")).save("reporte_energia.pdf");
};

/* ================================================
   Modo oscuro
================================================ */

document.getElementById("toggleTheme").onchange = (e)=>{
    document.getElementById("app").dataset.theme = e.target.checked ? "dark" : "light";
};

</script>

</body>
</html>
