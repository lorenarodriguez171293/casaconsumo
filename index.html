<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>App Energ√≠as Alternativas - Calculadora Integral</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- html2pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
    :root{
        --bg:#e6f7ff;
        --card:#ffffff;
        --primary:#007bff;
        --success:#28a745;
        --muted:#666;
    }
    [data-theme="dark"]{
        --bg:#0f1724;
        --card:#0b1220;
        --primary:#3b82f6;
        --success:#16a34a;
        --muted:#bbb;
    }

    *{box-sizing:border-box}
    body{
        margin:0;
        font-family: Inter, Arial, Helvetica, sans-serif;
        background:var(--bg);
        color:var(--muted);
        padding:20px;
        display:flex;
        justify-content:center;
    }

    .app {
        width:100%;
        max-width:1100px;
        background:var(--card);
        border-radius:12px;
        padding:22px;
        box-shadow:0 10px 30px rgba(2,6,23,0.12);
    }

    header{
        display:flex;
        gap:12px;
        align-items:center;
        justify-content:space-between;
    }

    h1{margin:0;color:var(--primary)}
    .controls {display:flex;gap:10px;align-items:center;}
    .btn {
        border:0;
        padding:10px 14px;
        border-radius:8px;
        cursor:pointer;
        color:white;
        font-weight:600;
    }
    .btn.primary{background:var(--primary)}
    .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,0,0,0.06)}
    .grid {
        display:grid;
        grid-template-columns: 1fr 420px;
        gap:18px;
        margin-top:18px;
    }

    /* left column */
    .panel{
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02));
        border-radius:10px;
        padding:14px;
        border:1px solid rgba(0,0,0,0.04);
    }

    .apartado-item{display:flex;gap:10px;align-items:center;margin-bottom:10px;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px}
    .apartado-item input[type="text"], .apartado-item input[type="number"]{
        padding:8px;border-radius:6px;border:1px solid #ccc;flex:1;
        background:transparent;color:inherit;
    }
    .apartado-item button{background:#dc3545;color:#fff;border:0;padding:8px 10px;border-radius:6px;cursor:pointer}

    label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}

    .row{display:flex;gap:10px;align-items:center}
    select, input[type="number"], input[type="text"]{
        padding:8px;border-radius:6px;border:1px solid #ccc;background:transparent;color:inherit;
    }

    .resultado-total{margin-top:12px;padding:12px;border-radius:8px;background:rgba(0,128,0,0.04);border:1px solid rgba(40,167,69,0.12)}
    .resultado-total h2{margin:0;color:var(--success)}
    .small-muted{font-size:13px;color:var(--muted)}

    /* right column */
    .right-col {display:flex;flex-direction:column;gap:12px}
    canvas{background:transparent;border-radius:8px;padding:8px}

    .extra-section{padding:10px;border-radius:8px;background:rgba(0,0,0,0.02)}

    footer {margin-top:16px;display:flex;gap:10px;justify-content:flex-end;}

    .toggle {display:inline-flex;align-items:center;gap:8px;cursor:pointer}
    .badge {background:#f0f0f0;padding:6px 8px;border-radius:8px;font-size:13px}

    @media (max-width:980px){
        .grid{grid-template-columns:1fr; }
        .right-col{order:2}
    }
</style>
</head>
<body>
<div class="app" id="app" data-theme="light">

    <header>
        <div>
            <h1>üåû App Energ√≠as Alternativas ‚Äî Calculadora Integral</h1>
            <div class="small-muted">Provincia / Subregi√≥n / Empresa / Segmento (Opci√≥n B)</div>
        </div>

        <div class="controls">
            <div class="toggle">
                <label class="small-muted">Modo oscuro</label>
                <input id="toggleTheme" type="checkbox" />
            </div>
            <button class="btn primary" id="exportarPDF">üìÑ Exportar PDF</button>
        </div>
    </header>

    <div style="height:12px"></div>

    <div class="grid">
        <!-- LEFT: Inputs & lista aparatos -->
        <div>
            <div class="panel">
                <h3>1) Datos de ubicaci√≥n y tarifa</h3>
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
                    <div style="flex:1;min-width:160px">
                        <label class="small-muted">Provincia</label>
                        <select id="provinciaSelect"></select>
                    </div>
                    <div style="flex:1;min-width:160px">
                        <label class="small-muted">Subregi√≥n / Ciudad</label>
                        <select id="regionSelect"></select>
                    </div>
                    <div style="flex:1;min-width:160px">
                        <label class="small-muted">Empresa el√©ctrica</label>
                        <select id="empresaSelect"></select>
                    </div>
                    <div style="flex:1;min-width:140px">
                        <label class="small-muted">Segmento</label>
                        <select id="segmentoSelect">
                            <option value="N1">N1</option>
                            <option value="N2">N2</option>
                            <option value="N3">N3</option>
                        </select>
                    </div>
                </div>

                <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
                    <div style="flex:1">
                        <label class="small-muted">Horas solares promedio (h/d√≠a)</label>
                        <input type="number" id="horasSolaresInput" step="0.1" min="0" />
                    </div>
                    <div style="flex:1">
                        <label class="small-muted">Tarifa ( $ / kWh )</label>
                        <input type="number" id="tarifaInput" step="0.1" min="0" />
                    </div>
                    <div style="flex:1;min-width:160px">
                        <label class="small-muted">Ajustar tarifa</label>
                        <button id="actualizarTarifa" class="btn ghost">Aplicar</button>
                    </div>
                </div>
                <div style="margin-top:8px" class="small-muted">
                    Los valores por defecto son ejemplos. <b>Podes editarlos</b> aqu√≠ y se usar√°n en los c√°lculos.
                </div>
            </div>

            <div class="panel" style="margin-top:12px">
                <h3>2) Electrodom√©sticos</h3>
                <button id="agregar-aparato" class="btn" style="background:var(--success)">‚ûï Agregar Aparato</button>

                <div id="lista-aparatos" style="margin-top:12px"></div>

                <div style="display:flex;gap:10px;margin-top:8px">
                    <button id="calcular-total" class="btn primary">Calcular Consumo</button>
                    <button id="limpiar" class="btn" style="background:#6c757d">Limpiar</button>
                </div>

                <div class="resultado-total" id="resultadoWrap" style="margin-top:12px">
                    <h2>Resultados</h2>
                    <div id="consumoResumen" class="small-muted">Consumo: 0.000 kWh/d√≠a ‚Ä¢ 0 kWh/mes ‚Ä¢ 0 kWh/a√±o</div>
                    <div id="costoResumen" class="small-muted" style="margin-top:6px">Costo estimado: $0 / mes</div>
                </div>
            </div>

            <div class="panel" style="margin-top:12px">
                <h3>3) Sugerencias y ranking</h3>
                <ul id="listaSugerencias"></ul>
                <h4>Ranking ‚Äî mayor a menor (kWh/d√≠a)</h4>
                <ol id="rankingAparatos"></ol>
            </div>

        </div>

        <!-- RIGHT: gr√°ficos y resumenes -->
        <div class="right-col">
            <div class="panel extra-section">
                <h3>Gr√°fico de consumo por aparato</h3>
                <canvas id="graficoConsumo" width="400" height="220"></canvas>
            </div>

            <div class="panel extra-section">
                <h3>Dimensionamiento solar</h3>
                <div id="dimensionSolar" class="small-muted">Necesit√°s: ‚Äî</div>
                <div style="margin-top:8px">
                    <label class="small-muted">Escenario bater√≠a (opcional, % del consumo diario a almacenar)</label>
                    <input type="number" id="porcentajeBackup" min="0" max="100" step="1" value="20" />
                </div>
            </div>

            <div class="panel extra-section">
                <h3>Compartir / Exportar</h3>
                <div style="display:flex;gap:8px">
                    <button id="compartirWhatsApp" class="btn" style="background:#25d366">Compartir WhatsApp</button>
                    <button id="botonExportarPDF" class="btn" style="background:#6f42c1">Exportar PDF</button>
                </div>
            </div>

        </div>
    </div>

    <footer>
        <div class="small-muted">Datos por defecto: horas solares y tarifas son editables. Seleccion√° subregi√≥n para poblar datos autom√°ticos.</div>
    </footer>

</div>

<script>
/* ============================
   Datos de ejemplo (editable)
   ============================ */

/*
 Estructura: provincias -> subregiones (ciudades) -> empresas disponibles
 Tambi√©n incluimos por defecto horas solares y tarifas ejemplo por empresa/segmento.
 Los valores son ilustrativos: modific√° en la UI seg√∫n tu fuente.
*/

const DB = {
    "Buenos Aires": {
        regiones: {
            "AMBA - Zona Norte": { horas: 4.2, empresas: ["EDENOR", "EDESUR"] },
            "AMBA - Zona Sur": { horas: 4.0, empresas: ["EDESUR", "EDENOR"] },
            "Bah√≠a Blanca": { horas: 4.8, empresas: ["EDEA", "EDEA2"] }
        }
    },
    "C√≥rdoba": {
        regiones: {
            "Capital": { horas: 5.0, empresas: ["EPEC"] },
            "Villa Carlos Paz": { horas: 5.1, empresas: ["EPEC"] }
        }
    },
    "Mendoza": {
        regiones: {
            "Capital": { horas: 5.6, empresas: ["EDESAL", "EMESA"] }
        }
    },
    "Santa Cruz / Patagonia": {
        regiones: {
            "Comodoro Rivadavia": { horas: 4.5, empresas: ["EPHE"] },
            "R√≠o Gallegos": { horas: 4.2, empresas: ["ERSA"] }
        }
    },
    "Salta / NOA": {
        regiones: {
            "Salta": { horas: 5.4, empresas: ["ESSA"] },
            "Jujuy": { horas: 5.6, empresas: ["JEMSE"] }
        }
    }
};

// Tarifas ejemplo por empresa y segmento (editable en la UI)
// Estructura: tarifas[empresa][segmento] = $/kWh
const tarifasEjemplo = {
    "EDENOR": { "N1": 160, "N2": 120, "N3": 80 },
    "EDESUR": { "N1": 165, "N2": 125, "N3": 85 },
    "EPEC":   { "N1": 150, "N2": 110, "N3": 70 },
    "EDEA":   { "N1": 155, "N2": 115, "N3": 75 },
    "EDESAL": { "N1": 148, "N2": 108, "N3": 68 },
    "EMESA":  { "N1": 152, "N2": 112, "N3": 72 },
    "EPHE":   { "N1": 170, "N2": 130, "N3": 90 },
    "ERESA":  { "N1": 160, "N2": 120, "N3": 80 },
    "ESSA":   { "N1": 158, "N2": 118, "N3": 78 },
    "JEMSE":  { "N1": 157, "N2": 117, "N3": 77 }
};

/* ============================
   Referencias DOM
   ============================ */

const provinciaSelect = document.getElementById('provinciaSelect');
const regionSelect = document.getElementById('regionSelect');
const empresaSelect = document.getElementById('empresaSelect');
const segmentoSelect = document.getElementById('segmentoSelect');
const horasSolaresInput = document.getElementById('horasSolaresInput');
const tarifaInput = document.getElementById('tarifaInput');
const actualizarTarifaBtn = document.getElementById('actualizarTarifa');

const agregarAparatoBtn = document.getElementById('agregar-aparato');
const listaAparatos = document.getElementById('lista-aparatos');
const calcularTotalBtn = document.getElementById('calcular-total');
const limpiarBtn = document.getElementById('limpiar');

const consumoResumen = document.getElementById('consumoResumen');
const costoResumen = document.getElementById('costoResumen');
const listaSugerencias = document.getElementById('listaSugerencias');
const rankingAparatos = document.getElementById('rankingAparatos');
const dimensionSolarEl = document.getElementById('dimensionSolar');
const porcentajeBackupInput = document.getElementById('porcentajeBackup');

const graficoCtx = document.getElementById('graficoConsumo').getContext('2d');
let grafico; // chart

const compartirWhatsAppBtn = document.getElementById('compartirWhatsApp');
const botonExportarPDF = document.getElementById('botonExportarPDF');
const exportarPDFheader = document.getElementById('exportarPDF');

const toggleTheme = document.getElementById('toggleTheme');
const appEl = document.getElementById('app');

/* ============================
   Inicializaci√≥n UI
   ============================ */

function poblarProvincias(){
    provinciaSelect.innerHTML = '';
    Object.keys(DB).forEach(p => {
        const opt = document.createElement('option');
        opt.value = p; opt.textContent = p;
        provinciaSelect.appendChild(opt);
    });
}

function poblarRegiones(prov){
    regionSelect.innerHTML = '';
    const regiones = DB[prov].regiones;
    Object.keys(regiones).forEach(r => {
        const opt = document.createElement('option');
        opt.value = r; opt.textContent = r;
        regionSelect.appendChild(opt);
    });
}

function poblarEmpresas(prov, region){
    empresaSelect.innerHTML = '';
    const empresas = DB[prov].regiones[region].empresas || [];
    empresas.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e; opt.textContent = e;
        empresaSelect.appendChild(opt);
    });
}

/* eventos para ir poblando y ajustar inputs por defecto */
provinciaSelect.addEventListener('change', () => {
    const prov = provinciaSelect.value;
    poblarRegiones(prov);
    poblarEmpresas(prov, regionSelect.value);
    aplicarDatosRegion();
});
regionSelect.addEventListener('change', () => {
    poblarEmpresas(provinciaSelect.value, regionSelect.value);
    aplicarDatosRegion();
});
empresaSelect.addEventListener('change', () => {
    aplicarDatosEmpresa();
});
segmentoSelect.addEventListener('change', () => {
    aplicarDatosEmpresa();
});

function aplicarDatosRegion(){
    const prov = provinciaSelect.value;
    const reg = regionSelect.value;
    const horas = DB[prov].regiones[reg].horas;
    horasSolaresInput.value = horas;
    aplicarDatosEmpresa();
}

function aplicarDatosEmpresa(){
    const empresa = empresaSelect.value;
    const segmento = segmentoSelect.value;
    const tarifa = (tarifasEjemplo[empresa] && tarifasEjemplo[empresa][segmento]) ? tarifasEjemplo[empresa][segmento] : 150;
    tarifaInput.value = tarifa;
}

/* poblar por primera vez */
poblarProvincias();
provinciaSelect.selectedIndex = 0;
poblarRegiones(provinciaSelect.value);
regionSelect.selectedIndex = 0;
poblarEmpresas(provinciaSelect.value, regionSelect.value);
empresaSelect.selectedIndex = 0;
aplicarDatosRegion();

/* ============================
   Manejo de lista de aparatos
   ============================ */

function crearAparato(nombre = '', potencia = '', horas = ''){
    const cont = document.createElement('div');
    cont.className = 'apartado-item';
    cont.innerHTML = `
        <input class="inp-nombre" type="text" placeholder="Nombre del aparato (Ej: Heladera)" value="${nombre}">
        <input class="inp-pot" type="number" placeholder="Potencia (W)" value="${potencia}">
        <input class="inp-horas" type="number" placeholder="Horas/d√≠a" value="${horas}" min="0" max="24" step="0.1">
        <button class="btn-elim">üóëÔ∏è</button>
    `;
    cont.querySelector('.btn-elim').addEventListener('click', () => {
        cont.remove();
        calcularTotalConsumo();
    });
    listaAparatos.appendChild(cont);
    return cont;
}

/* botones */
agregarAparatoBtn.addEventListener('click', ()=> crearAparato('', '', ''));
limpiarBtn.addEventListener('click', ()=>{
    listaAparatos.innerHTML='';
    consumoResumen.textContent = 'Consumo: 0.000 kWh/d√≠a ‚Ä¢ 0 kWh/mes ‚Ä¢ 0 kWh/a√±o';
    costoResumen.textContent = 'Costo estimado: $0 / mes';
    listaSugerencias.innerHTML = '';
    rankingAparatos.innerHTML = '';
    if(grafico){ grafico.destroy(); grafico=null }
    dimensionSolarEl.textContent = 'Necesit√°s: ‚Äî';
});

/* precargar algunos aparatos */
crearAparato('Heladera', 150, 24);
createInitialLight();

/* funci√≥n auxiliar para agregar ejemplo de foco multiple */
function createInitialLight(){
    crearAparato('Foco LED (x4) - total 40W', 40, 6);
    crearAparato('Televisor', 120, 5);
}

/* ============================
   C√°lculos centrales
   ============================ */

function calcularTotalConsumo(){
    const items = Array.from(document.querySelectorAll('.apartado-item'));
    let totalKwhDia = 0;
    const detalles = [];

    items.forEach(div => {
        const nombre = div.querySelector('.inp-nombre').value || 'Sin nombre';
        const pot = parseFloat(div.querySelector('.inp-pot').value) || 0;
        const horas = parseFloat(div.querySelector('.inp-horas').value) || 0;
        if(pot>0 && horas>=0){
            const kwh = (pot * horas) / 1000;
            totalKwhDia += kwh;
            detalles.push({nombre, pot, horas, kwh});
        }
    });

    // resumenes
    const mensual = totalKwhDia * 30;
    const anual = totalKwhDia * 365;

    consumoResumen.textContent = `Consumo: ${totalKwhDia.toFixed(3)} kWh/d√≠a ‚Ä¢ ${mensual.toFixed(1)} kWh/mes ‚Ä¢ ${anual.toFixed(1)} kWh/a√±o`;

    // costo
    const tarifa = parseFloat(tarifaInput.value) || 0;
    const costoMensual = mensual * tarifa;
    costoResumen.textContent = `Costo estimado: $${Math.round(costoMensual).toLocaleString('es-AR')} / mes (tarifa ${tarifa.toFixed(2)} $/kWh)`;

    // ranking
    const orden = detalles.slice().sort((a,b)=> b.kwh - a.kwh);
    rankingAparatos.innerHTML = '';
    orden.forEach(it=>{
        const li = document.createElement('li');
        li.textContent = `${it.nombre} ‚Äî ${it.kwh.toFixed(3)} kWh/d√≠a`;
        rankingAparatos.appendChild(li);
    });

    // sugerencias simples
    generarSugerencias(totalKwhDia, orden);

    // grafico
    generarGrafico(detalles);

    // dimensionamiento solar
    calcularDimensionSolar(totalKwhDia, tarifa);

    return {totalKwhDia, mensual, anual, costoMensual, detalles};
}

/* ============================
   Sugerencias
   ============================ */

function generarSugerencias(totalKwhDia, orden){
    listaSugerencias.innerHTML = '';
    if(totalKwhDia <= 0){
        listaSugerencias.innerHTML = '<li>Agreg√° electrodom√©sticos para calcular recomendaciones.</li>';
        return;
    }

    // Reglas simples
    if(totalKwhDia > 8) addSug('Reduc√≠ el uso del aire acondicionado y ajust√° a 24¬∞C cuando sea posible.');
    if(totalKwhDia > 5) addSug('Cambi√° las l√°mparas por LED y us√° reguladores/zonas de luz.');
    if(totalKwhDia > 3) addSug('Revis√° la eficiencia de la heladera y el sellado de puertas.');
    if(totalKwhDia > 2) addSug('Us√° regletas para apagar equipos en standby.');
    if(totalKwhDayPercent := (orden[0] && (orden[0].kwh/totalKwhDia) > 0.4)) {
        addSug(`El aparato ${orden[0].nombre} consume m√°s del 40% del total ‚Äî evalu√° su reemplazo.`);
    }
    if(totalKwhDia < 3) addSug('Tu hogar tiene consumo bajo. Podr√≠as considerar un peque√±o sistema solar para autogenerar parte de la energ√≠a.');

    function addSug(txt){ const li=document.createElement('li'); li.textContent=txt; listaSugerencias.appendChild(li) }
}

/* ============================
   Gr√°fico (Chart.js)
   ============================ */

function generarGrafico(detalles){
    const labels = detalles.map(d=>d.nombre);
    const data = detalles.map(d=>parseFloat(d.kwh.toFixed(3)));
    if(grafico) grafico.destroy();

    grafico = new Chart(graficoCtx, {
        type:'bar',
        data: {
            labels,
            datasets:[{
                label:'kWh por aparato (d√≠a)',
                data,
                backgroundColor: labels.map((_,i)=>`rgba(54,162,235,0.6)`),
                borderColor: labels.map((_,i)=>`rgba(54,162,235,1)`),
                borderWidth:1
            }]
        },
        options:{
            responsive:true,
            scales:{ y: { beginAtZero:true } }
        }
    });
}

/* ============================
   Dimensionamiento solar y backup
   ============================ */

function calcularDimensionSolar(kwhDia, tarifa){
    const horasSolar = parseFloat(horasSolaresInput.value) || 4.5;
    const eficienciaSistema = 1.3; // factor p√©rdidas
    const potenciaKwp = (kwhDia / horasSolar) * eficienciaSistema; // kW pico
    const panel450 = 0.45; // kW
    const cantidadPaneles = Math.max(0, Math.ceil(potenciaKwp / panel450));

    // Backup
    const porcentajeBackup = parseFloat(porcentajeBackupInput.value) || 0;
    const energiaBackupKwh = (kwhDia * (porcentajeBackup/100));
    // suposici√≥n: queremos autonom√≠a de 1 d√≠a de backup
    const bateriaNecesariaKwh = energiaBackupKwh; // kWh
    // conversi√≥n suelta para bater√≠as: 1 kWh bater√≠a ~ 1 kWh usable (depende de sistema)
    // mostrar resultados:
    dimensionSolarEl.innerHTML = `
        Con ${horasSolar} h/d√≠a promedio, necesit√°s aprox. <b>${potenciaKwp.toFixed(2)} kW</b> instalado
        (~<b>${cantidadPaneles}</b> paneles de 450W).<br>
        Si quer√©s cubrir ${porcentajeBackup}% del consumo diario con bater√≠a, necesit√°s aprox. <b>${bateriaNecesariaKwh.toFixed(2)} kWh</b> de capacidad (1 d√≠a de autonom√≠a).
    `;
}

/* ============================
   Event handlers: botones
   ============================ */

/* aplicar tarifa editable */
actualizarTarifaBtn.addEventListener('click', ()=>{
    const empresa = empresaSelect.value;
    const segmento = segmentoSelect.value;
    const tarifa = parseFloat(tarifaInput.value) || 0;
    if(!tarifasEjemplo[empresa]) tarifasEjemplo[empresa] = {};
    tarifasEjemplo[empresa][segmento] = tarifa;
    alert(`Tarifa actualizada: ${empresa} ${segmento} = $${tarifa.toFixed(2)}/kWh (valor guardado en memoria local de esta sesi√≥n)`);
});

/* calcular */
calcularTotalBtn.addEventListener('click', ()=>{
    calcularTotalConsumo();
});

/* compartir whatsapp */
compartirWhatsAppBtn.addEventListener('click', ()=>{
    const res = calcularTotalConsumo();
    const texto = `Mi consumo estimado es ${res.totalKwhDia?.toFixed(3)||0} kWh/d√≠a (${(res.mensual||0).toFixed(1)} kWh/mes). Costo aprox. $${Math.round(res.costoMensual||0)} / mes.`;
    const url = `https://api.whatsapp.com/send?text=${encodeURIComponent(texto)}`;
    window.open(url,'_blank');
});

/* exportar PDF (se captura todo el .app) */
botonExportarPDF.addEventListener('click', ()=>{
    const elemento = document.querySelector('.app');
    html2pdf().set({ margin: 10, filename:'reporte_energia.pdf', html2canvas:{scale:2} }).from(elemento).save();
});
exportarPDFheader.addEventListener('click', ()=> botonExportarPDF.click());

/* toggle theme */
toggleTheme.addEventListener('change', (e)=>{
    appEl.setAttribute('data-theme', e.target.checked ? 'dark' : 'light');
});

/* ============================
   Acciones iniciales
   ============================ */

calcularTotalConsumo(); // primer c√°lculo con valores cargados

</script>
</body>
</html>
